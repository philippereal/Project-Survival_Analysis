---
title: "Rapport - Valeurs Extrêmes"
btitle: ""
author: "Alexis Guyonvarch - Philippe Real"
date: '`r format(Sys.time(), " %d %B, %Y")`'
abstract: "This is my abstract."
keywords: "R"
output:
  html_document:
    df_print: paged
    toc: yes
  word_document:
    toc: yes
  pdf_document:
    toc: yes
    toc_depth: 3
    fig_caption: yes
    keep_tex: yes
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r eval=FALSE, include=FALSE}
install.packages("evd")
install.packages("evir")
install.packages("ismev")
install.packages("fExtremes")
install.packages("extRemes")
install.packages("fitdistrplus")
install.packages("chron")
install.packages("lubridate")
```

```{r,echo=FALSE, message=FALSE, warning=FALSE, r,echo=FALSE}
rm(list=ls())

library(evd)
library(evir)
library(ismev)
library(fExtremes)
library(extRemes)
library(fitdistrplus)
library(chron)
library(lubridate)
```

# Introduction

## Rappel des notions fondamentales de la théorie des valeurs extrêmes
On étudie un n-échantillon iid de v.a $X_1,X_2,....,X_n$ de même loi, de fonction de répartition F, et on considère la v.a $X_{n,n}=max(X_1,X_2,....,X_n)$ dont on cherche à décrire statistiquement le comportement asymptotique.

Par la propriété d'indépendance de l'échantillon, la fonction de répartition la loi du max $X_{n,n}$ peut s'écrire aussi $F^n$.

### Domaine d'attraction et théorème des valeurs extrêmes
La théorie des valeurs extrêmes s'appuie sur la notion de "Domaine Maximum d'attraction" MDA(G) où $G$ est la fonction de répartition d'une v.a non dégénérée (i.e associée à une va non constante) limite en loi (?) de la suite "rescalée?" $X_{n,n}^*=\frac{X_{n,n}-b_n}{a_n}$.

Plus précisemment, on dit que F appartient au domaine d'attraction DMA(G) de G ssi il existe deux suites $a_n$>0 et $b_n$ telles que : 
$\displaystyle \lim_{n \to +\infty} F^n(a_nx+b_n)=G(x)$ $\forall x \in \mathbb{R}$
De manière équivalent : $X_{n,n}^*\xrightarrow{d} Y$ où $Y$ est une loi ayant pour fonction de répartition $G$.

Le domaine d'attraction est unique pour les paramètre de position et de dimensionnement (scale) fixés.  

Le théorème des valeurs extrêmes stipule qu'il n'y a que 3 grandes familles (ou ensemble) de domaines d'attractions ou dit autrement 3 grandes familles de fonctions de répartitions limites pour $X_{n,n}^*$. Qui sont les familles de Gumbel, Frêchet et Weibull. Ces familles de lois des extrêmes ont des profiles et des comportement asymptotique différents.

Si la loi limite $F \in MDA(G)$ alors la lois de répartition G est de l'une des formes suivantes : 

- Fréchet: définit pour $\gamma >0$ par $\phi^{F}(x)=exp(-\frac{(x-b)}{a})^{-1/\gamma}$ si x > b et 0 sinon.
- Weibull: définit pour $\gamma >0$ par $\phi^{W}(x)=exp(\frac{(x-b)}{a})^{1/\gamma}$   si x < b et 1 sinon.
- Gumbel:  définit par $\phi^{G}(x)=exp(-exp(-\frac{(x-b)}{a}))$ si x $\in \mathbb{R}$.

### GEV (General Extreme Distribution)
On peut reformuler ce théorème et obtenir une forme unique pour G, la distibution générale des valeurs extrêmes ou GEV, c'est le théorème de Fisher-Tippett-Gnedenko, qui peut être vu comme un équivalent du CLT pour les valeurs extrêmes :

Si il existe deux suites normalisantes $(a_n)_{n \geq 1}$>0 et $(b_n)_{n \geq 1} \in \mathbb{R}$ ainsi qu'une distribution non dégénérée $H$ telles que :

$\displaystyle\lim_{n \to +\infty} P(\frac{X_{n,n}-b_n}{a_n} \leq \gamma)=\displaystyle\lim_{n \to +\infty} F^n(a_nx+b_n)=H(x)$ 

Alors $H$ est de la forme suivante :  

- $H_{\gamma,a,b}(x)=exp\{-[1+\gamma(\frac{x-b}{a})]^{-1/\gamma}\}$ et définit sur l'ensemble $\{x:1+\gamma \frac{x-b}{a} >0 \}$ où $-\infty <b<+\infty,$ $a>0$ et $\gamma \in \mathbb{R}$

Si F vérifie ce théorème, on dit alors que F appartient au domaine d'attraction de$H_{\gamma,a,b}$  

En se basant sur le signe de $\gamma$ on distingue les trois domaines d'attraction:

- Si $\gamma<0$ $F$ est dit appartenir au domaine d'attraction de type Weibull $F \in MDA(Weibull)$ des short tail distributions. 
- Si $\gamma=0$ $F$ est dit appartenir au domaine d'attraction de type Gumbel $F \in MDA(Gumbel)$ des light tail distributions.
- Si $\gamma>0$ $F$ est dit appartenir au domaine d'attraction de type Fréchet $F \in MDA(Fréchet)$ des heavy tail distributions. 

```{r echo=FALSE, fig.height=4, fig.width=15}
par(mfrow=c(1,2))
x <- seq(0,10,,200)

plot(x, devd(x, 1, 1, -0.5), type="l", col="blue", lwd=1.5,ylab="GEV df", main="General Extreme distibutions - GED")
# Note upper bound at 1 - 1/(-0.5) = 3 in above plot.
lines(x, devd(x, 1, 1, 0), col="lightblue", lwd=1.5)
lines(x, devd(x, 1, 1, 0.5), col="darkblue", lwd=1.5)
legend("topright", legend=c("(reverse) Weibull", "Gumbel", "Frechet"),
col=c("blue", "lightblue", "darkblue"), bty="n", lty=1, lwd=1.5)

# Emphasize the tail differences more by using different scale parameters.

plot(x, devd(x, 1, 0.5, -0.5), type="l", col="blue", lwd=1.5,
ylab="GEV df", main="Emphasize the tail differences more by using different scale parameters")
lines(x, devd(x, 1, 1, 0), col="lightblue", lwd=1.5)
lines(x, devd(x, 1, 2, 0.5), col="darkblue", lwd=1.5)
legend("topright", legend=c("(reverse) Weibull","Gumbel", "Frechet"),
col=c("blue", "lightblue", "darkblue"), bty="n", lty=1, lwd=1.5)
text(2,0.6,expression(gamma == -0.5))
text(1.5,0.3,expression(gamma == 0))
text(1,0.15,expression(gamma == 1.5))

```

### GPD (Global Pareto Distribution)
[TODO 2: Continuer le résumé...]

Dans l'approche GPD, on va s'intéresser à la distibution des excès, au delà d'un certain seuil, bien choisi.

On a une équivalence entre les approches GPD/GEV. En partant du théorème fondamental, pour un échantillon important, n suffisament grand on a l'approximation suivante:
- $F^n(u) \approx exp\{-[1+\gamma(\frac{u-b}{a})]^{-1/\gamma}\}$ avec a>0 et $(b,\gamma) \in \mathbb{R}^2$
En appliquant la transformation n.log à cette expression puis en effectuant un DL de Taylor, on obtient la famille de distributions de Pareto généralisée (GPD) :
- $G_{\gamma,\sigma}=1-(1+\gamma\frac{y}{\sigma})^{-1/\gamma}$ pour tout $y \in \mathbb{R}$ tel que $1+\gamma\frac{y}{\sigma}>0$
Le cas $\gamma=0$ est obtenu comme $\displaystyle\lim_{\gamma \to 0}G_{\gamma,\sigma}(y)=G_{0,\sigma}=1+exp(-\frac{y}{\sigma})$

```{r echo=FALSE, fig.height=4, fig.width=15}
par(mfrow=c(1,2))
x <- seq(0,10,,200)
plot(x, devd(x, 1, 1, -0.5, 1, type="GP"), type="l", col="blue", lwd=1.5,ylab="GP df", main="Global Pareto distibutions - GPD")
lines(x, devd(x, 1, 1, 0, 1, type="GP"), col="lightblue", lwd=1.5)
lines(x, devd(x, 1, 1, 0.5, 1, type="GP"), col="darkblue", lwd=1.5)
legend("topright", legend=c("Beta", "Exponential", "Pareto"),col=c("blue", "lightblue", "darkblue"), bty="n", lty=1, lwd=1.5)

plot(x, devd(x, 1, 0.5, -0.5, 1, type="GP"), type="l", col="blue", lwd=1.5,
ylab="GP df", main="Emphasize the tail differences more by using different scale parameters")
lines(x, devd(x, 1, 1, 0, 1, type="GP"), col="lightblue", lwd=1.5)
lines(x, devd(x, 1, 2, 0.5, 1, type="GP"), col="darkblue", lwd=1.5)
legend("topright", legend=c("Beta", "Exponential", "Pareto"),col=c("blue", "lightblue", "darkblue"), bty="n", lty=1, lwd=1.5)
```

On remarque, que $G_{\gamma,\sigma}(z)=1+log(H_{\gamma}(z))$ avec $b=0$ et $a=\sigma$
La dualité entre les  deux approches GEV et GPD montre l'importance particulière du paramètre de forme $\gamma$.

- Si $\gamma<0$ la distribution des excès a une borne supérieure de $\mu - \sigma/\gamma$
- Si $\gamma>0$ la distribution des excès n'a pas de limite supérieure.
- Si $\gamma=0$ la distribution des excès est aussi non bornée.

De la même manière on a 3 formes particulières de distributions associées :

- Si $\gamma<0$ alors $G_{\gamma,\sigma}$ est la fonction de répartition de $Exp(1/\sigma)$.
- Si $\gamma>0$ alors $G_{\gamma,\sigma}$ est la fonction de répartition de $Unif[0,\sigma]$. 
- Si $\gamma=0$ alors $G_{\gamma,\sigma}$ est la fonction de répartition de la distribution de Pareto translatée.

On rappelle le théorème de Pickands

Si $F \in MDA(H_{\gamma}) \iff \exists$ $a >0$ $|\displaystyle\lim_{n \to +\infty}\displaystyle\sup_{y \in[0,x_F-u]} |\bar{F}_{u}(y)-\bar{G}_{\gamma,a(u)}(y)|$


## Plan - Démarche

Dans chacune des 3 partie du rapport, on va étudier une série et chercher à déterminer la distribution limite des valeurs extrêmes.
On commencera par une decription statistique de chaque série étudié puis on va chercher à estimer les paramètres scale: $a=\lim_{n\to +\infty} a_n$ et shape: $b=\lim_{n \to +\infty}b_n$
qui sont associés aux différentes catégories de lois limites et à la série étudiée.

On déterminera ensuite la famille la plus appropriée à la série et le domaine d'attraction associé.
On terminera notre étude avec une estimation de la probabilité et du niveau de retour. [associé à chacune de ces familles ou distribution de la loi des extrêmes]

[TODO 3: Reprendre continuer...]

# Partie I - Comparaison des approches GEV et GPD sur les données *Marseille* 

On s'intéresse dans cette première partie, à la pluviométrie dans la vile de Marseille sur la période allant de 1864 à 1991.

Cette étude est réalisée à patir des données d'accumulations pluviométriques quotidiennes de $10^{-1}$ mm dans la vile de Marseille pendant 127 ans d'observations (1864–1991). La première date est le 1er août 1864. Tous les 29 février ont été supprimés.
Pour cet ensemble de données, on va utiliser les deux approches (GEV et GPD) et les comparer.

## Lecture des données - description statistique

```{r echo=FALSE, fig.height=5, fig.width=15, message=FALSE, warning=FALSE}
pluies = read.table("marseille.txt")[,1]
pluies.ts = ts(pluies,start=c(1864,213),frequency=365) # 213: 1 aout 1864

par(mfrow=c(1,2))
plot(pluies.ts,main="Pluies maximales journalieres Marseille",type="h")
matPluies = matrix(pluies,365,127) # decoupage en annees aout-juillet
maxPluies = apply(matPluies,2,max,na.rm = TRUE)
vecAn = 1864:1990

emplot(maxPluies,main="Fonction de survie empirique - précipitations max>130mm")
```

* summary, quantiles, histogramme des précipitations max / an
(cf. slides Intro)

```{r echo=FALSE}
summary(maxPluies)
```


```{r echo=FALSE}
quantile(maxPluies,probs=c(0,0.25,0.5,0.75,1))
```

```{r echo=FALSE, fig.height=5, fig.width=15}
par(mfrow=c(1,2))
h <- hist(maxPluies,main="Maximum / années des précipitations journalières", xlab="Niveau des précipitations",col="lightblue",ylim=c(0,50),breaks=10)
text(h$mids,h$counts,labels=h$counts, adj=c(0.5, -0.5))
plot(maxPluies,pch=20)
#hist(maxPluies, breaks="FD", freq=FALSE, xlab="GEV distributed random variables", col="darkblue")
```

* Comparaison à une loi Log-normale et Gamma

```{r echo=FALSE, message=FALSE, warning=FALSE}
fitLognorm<-fitdist(maxPluies,"lnorm")
fitGamma<-fitdist(maxPluies,"gamma")
```

```{r echo=FALSE}
sLnorm<-summary(fitLognorm)
sGamma<-summary(fitGamma)
```

```{r echo=FALSE}
sLnorm
```

```{r echo=FALSE}
sGamma
```


```{r echo=FALSE, fig.height=5, fig.width=15, message=FALSE, warning=FALSE}
par(mfrow=c(1,2))

denscomp(fitLognorm,legendtext = "Lognormal",lwd=2)
denscomp(fitGamma,legendtext = "Gamma",lwd=2)
```


```{r echo=FALSE}
qlnorm(1/400,meanlog=sLnorm$estimate[1],sdlog=sLnorm$estimate[2],lower.tail = FALSE)
qlnorm((1-1/400),meanlog=sLnorm$estimate[1],sdlog=sLnorm$estimate[2],lower.tail = TRUE)
qgamma(1/400, sGamma$estimate[1], sGamma$estimate[2], lower.tail = FALSE)
qgamma((1-1/400), sGamma$estimate[1], sGamma$estimate[2], lower.tail = TRUE)
qlnorm(1/4000,meanlog=sLnorm$estimate[1],sdlog=sLnorm$estimate[2],lower.tail = TRUE)
qgamma(1/4000, sGamma$estimate[1], sGamma$estimate[2], lower.tail = FALSE)
summary(maxPluies)
```

## Choix du niveau des blocs (GEV) et du seuillage (GPD)

L'approche des blocs maximums [TODO4: A compléter]
On divise les data en blocs et on extrait le maximum pour chacun des blocs.

* Utilisation de la fonction $blockmaxxer$ du package $extRemes$

```{r echo=FALSE, fig.height=5, fig.width=15}

pluies.df <- data.frame(date = c(time(pluies.ts)),precip = c(pluies.ts) )
pluies.dates <-  as.Date(seq.dates("08/01/1864", by="days",length=46355),format = "%m/%d/%y",origin = "1864-08-01")
pluies.dates.df<-data.frame(pluies.dates)
pluies.precip.df <- data.frame(pluies)
pluies.df<- data.frame( date = c(pluies.dates.df$pluies.dates), month=c(format(pluies.dates.df$pluies.dates,"%m")) , year=c(format(pluies.dates.df$pluies.dates,"%Y")), precip = c(pluies))

pluiesBMaxM<-blockmaxxer(pluies.df, blocks = paste0(pluies.df$year,pluies.df$month),which="precip")
pluiesBMaxY<-blockmaxxer(pluies.df, blocks = pluies.df$year,which="precip")

par(mfrow=c(1,2))
plot(pluiesBMaxM$date, pluiesBMaxM$precip, xlab = "Year", ylab = "Precipitation Max / Mois (en mm)",cex = 1.25, cex.lab = 1.25,col = "darkblue", bg = "lightblue", pch = 21) 
points(pluiesBMaxM$date, pluiesBMaxM$precip, col="darkred", cex=1.5)

plot(pluiesBMaxY$date, pluiesBMaxY$precip, xlab = "Year", ylab = "Precipitation max / year (en mm)",cex = 1.25, cex.lab = 1.25,col = "darkblue", bg = "lightblue", pch = 21) 
points(pluiesBMaxY$date, pluiesBMaxY$precip, col="darkred", cex=1.5)


```

* Ajustement GEV sur les max annuels =>?

[TODO 5: A voir si utile]
```{r echo=FALSE}
n <- length(pluies); PluieMat <- matrix(pluies[1:(n-n%%365)],nrow=365)
PluieMatrix <- apply(PluieMat,2,max)
fgev.pluie <- fgev(PluieMatrix)
fgev.pluie
```

- Dans ce qui suit on va utilser la série des max / an construites précedemment.


### Choix du seuil pour l'approche GPD

* function findthresh of the package evir (p38 cours III)

```{r echo=FALSE}
findthresh(pluies,c(1,10,100))
```

```{r echo=FALSE}
seuil<-findThreshold(as.timeSeries(pluies), n = c(10, 50, 100))
seuil
```

```{r echo=FALSE, fig.height=5, fig.width=15}
par(mfrow=c(1,2))
plot(pluies.ts,main="Pluies maximales journalieres Marseille")
abline(h=seuil[1],col="red")
abline(h=seuil[2],col="red",lty=2)
abline(h=seuil[3],col="red",lty=3)
legend('top',c("seuil à 10","seuil à 50","seuil à 100"),col="red",lty=c(1,2,3),lwd = rep(2,2))
mrlplot(pluies,main=" Mean Residual Life Plot - pécipitations à Marseille")
```

seuil à 600 580 cf p57 cours GPD

```{r echo=FALSE, fig.height=6, fig.width=8}
threshrange.plot(pluies, r = c(0, 1150), nint=20)
```

## Estimation des paramètres shape et- scale par MLE et PWM.

### Approche GEV

[TOD6: l'approche GEV donne de mauvais résultats, pourquoi?]
```{r echo=FALSE, message=FALSE, warning=FALSE}
FitMle=fevd(pluies,type="GEV",method="MLE",time.units="days")
gev<-FitMle
ci.gev<-ci(FitMle,type="parameter")

gev.scale<- gev$results[1]$par[1]
gev.shape<- gev$results[1]$par[2]

FitGumb=fevd(pluies,type="Gumbel",method="MLE",time.units="days")
gmb<-FitGumb
ci.gmb<-ci(FitMle,type="parameter")
gmb.scale<- gmb$results[1]$par[1]
gmb.shape<- gmb$results[1]$par[2]
```

Méthode          |        scale               |            shape           |
---------------- | -------------------------- | -------------------------- |
GEV - MLE GEV    | `r gev$results[1]$par[1]`  | `r gev$results[1]$par[2]`  |
GEV - MLE Gumbel | `r gmb$results[1]$par[1]`  | `r gmb$results[1]$par[2]`  |

* Approximations des paramètres $scale$ et $shape$ et Intervalles de confiance

```{r echo=FALSE}
ci.gev
ci.gmb
#ci.gev.mmt
```

```{r echo=FALSE, fig.height=8, fig.width=15}
plot(FitMle)
```

```{r echo=FALSE, fig.height=8, fig.width=12}
#https://www.rdocumentation.org/packages/extRemes/versions/2.0-11/topics/fevd
## on peut isoler les graphique de la manière suivantes
par(mfrow=c(2,2))
plot(FitGumb,type ="qq",main="qq-plot Gumbel")
plot(FitGumb,type ="qq2",main="qq2 Gumbel")
plot(FitGumb,type ="density",main="Density Gumbel")
plot(FitGumb,type ="rl",main="Return period - Gumbel" )
```

```{r echo=FALSE, fig.height=8, fig.width=12}
#plot(FitMMT)
```

### Approche GPD

* Estimation des paramètres par maximum de vraissamblance dans l'approche GPD (p47 cours GPD)

On utilise la fonction R fved avec 2 la méthode MLE et des moments

```{r echo=FALSE}

seuil<-600

FitthreshMle=fevd(pluies,threshold=seuil,type="GP",method="MLE",time.units="days")#,time.units="day")
mle<-FitthreshMle
ci.mle<-ci(FitthreshMle,type="parameter")

FitthreshMleExp=fevd(pluies,threshold=seuil,type="Exponential",method="MLE",time.units="days")
exp<-FitthreshMleExp
ci.exp<-ci(FitthreshMleExp,type="parameter")

FitthreshMleMMT=fevd(pluies,threshold=seuil,type="GP",method="Lmoments",time.units="days")
mmt<-FitthreshMleMMT
ci.mmt<-ci(FitthreshMleMMT,type="parameter")

mle.scale<- mle$results[1]$par[1]
mle.shape<- mle$results[1]$par[2]

exp.scale<- exp$results[1]$par[1]
exp.shape<- exp$results[1]$par[2]

mmt.scale<- mmt$results[1]
mmt.shape<- mmt$results[2]
```


Méthode          |        scale              |            shape          |
---------------- | ------------------------- | ------------------------- |
GPD - MLE GV     | `r mle$results[1]$par[1]` | `r mle$results[1]$par[2]` |
GPD - MLE Exp    | `r exp$results[1]$par[1]` | `r exp$results[1]$par[2]` |
GPD - Moment GV  | `r mmt$results[1]`        | `r mmt$results[2]`        |


* Approximations des paramètres $scale$ et $shape$ et Intervalles de confiance

```{r echo=FALSE}
ci.mle
ci.exp
ci.mmt
```

\pagebreak

[TODO: validation des approximations à partir des graphiques ggplot ggplot2 density]

* Graphique - GPD estimé par MLE 

```{r echo=FALSE, fig.height=8, fig.width=15}
plot(FitthreshMle)
```

* Graphique - Exponentiel estimé par MLE 

```{r echo=FALSE, fig.height=8, fig.width=12}
plot(FitthreshMleExp)
```

\pagebreak

* Graphique - GPD estimé par la PWD 

```{r echo=FALSE, fig.height=8, fig.width=12}
plot(FitthreshMleMMT)
```
[TODO: validation des approximations à partir des graphiques ggplot ggplot2 density]


```{r eval=FALSE, include=FALSE}
### Approche GPD avec $fpot$ 
fitpot.pluies <- fpot(pluies,threshold=600)
fitpot.pluies
profile.pluies <- profile(fitpot.pluies,which="shape")

par(mfrow=c(2,2))
plot(profile.pluies)
plot(fitpot.pluies)
```


## Domaine d'attraction

* GEV

On étudie le signe de $\gamma$ pour connaître le type de domaine d'attraction: Weibull, Gumbel ou Fréchet.

- Si $\gamma<0$ $F \in MDA(Weibull)$ des short tail distributions. 
- Si $\gamma=0$ $F \in MDA(Gumbel)$ des light tail distributions.
- Si $\gamma>0$ $F \in MDA(Fréchet)$ des heavy tail distributions. 

On se base sur l'intervalle de confiance de l'estimation de $\gamma$ obtenu précédement

```{r echo=FALSE}

```

* GPD 

```{r echo=FALSE}

```

## Niveau de retour et interprétation

* GEV

- si $\gamma=0$ le tracé est linéaire
- si $\gamma<0$ le tracé est convexe avec une limite asymptotique : $b-\frac{a}{\gamma}$
- si $\gamma>0$ le tracé est concave et n'a pas de borne finie 

 
```{r echo=FALSE}

```


* GPD 

```{r echo=FALSE}

```

## Estimation du niveau de retour correspondant à une période 100 ans et 1000 ans

* GEV

```{r echo=FALSE}
ci.gev.100 <- ci(FitMle,type="return.level",return.period = 100)
ci.gmb.100 <- ci(FitGumb,type="return.level",return.period = 100)
#ci.mmt.100 <- ci(FitMMT,type="return.level",return.period = 100)
ci.gev.1000 <- ci(FitMle,type="return.level",return.period = 1000)
ci.gmb.1000 <- ci(FitGumb,type="return.level",return.period = 1000)
#ci.mmt.1000 <- ci(FitMMT,type="return.level",return.period = 1000)
#Moment GV      | `r ci.mmt.100[2]` | `r ci.mmt.100[1]`  | `r ci.mmt.100[3]`  |
# Moment GV      | `r ci.mmt.1000[2]`| `r ci.mmt.1000[1]` | `r ci.mmt.1000[3]` |
```

Méthode         |  100-year return  |  IC 95% borne Inf  | IC 95% borne Sup   |
--------------- | ----------------- | ------------------ | ------------------ |
MLE GEV         | `r ci.gev.100[2]` | `r ci.gev.100[1]`  | `r ci.gev.100[3]`  |
MLE Gumbel      | `r ci.gmb.100[2]` | `r ci.gmb.100[1]`  | `r ci.gmb.100[3]`  |


Méthode         |  1000-year return |  IC 95% borne Inf  | IC 95% borne Sup   |
--------------- | ----------------- | ------------------ | ------------------ |
MLE GEV         | `r ci.gev.1000[2]`| `r ci.gev.1000[1]` | `r ci.gev.1000[3]` |
MLE Gumbel      | `r ci.gmb.1000[2]`| `r ci.gmb.1000[1]` | `r ci.gmb.1000[3]` |


```{r echo=FALSE}
ret.gev<- return.level(FitMle, return.period = c(2, 20, 100,1000))
ret.gmb<- return.level(FitGumb, return.period = c(2, 20, 100,1000))
#ret.mmt<- return.level(FitthreshMleMMT, return.period = c(2, 20, 100,1000))
#Moment GV      | `r ret.mmt[1]` | `r ret.mmt[3]` | `r ret.mmt[3]` | `r ret.mmt[4]` |
```

Méthode         |  2-year level  |  20-year level | 100-year level | 1000-year level|
--------------- | -------------- | -------------- | -------------- | -------------- |
MLE GEV         | `r ret.gev[1]` | `r ret.gev[2]` | `r ret.gev[3]` | `r ret.gev[4]` |
MLE Gumbel      | `r ret.gmb[1]` | `r ret.gmb[2]` | `r ret.gmb[3]` | `r ret.gmb[4]` |


* GPD 

```{r echo=FALSE}
ci.mle.100 <- ci(FitthreshMle,type="return.level",return.period = 100)
ci.exp.100 <- ci(FitthreshMleExp,type="return.level",return.period = 100)
ci.mmt.100 <- ci(FitthreshMleMMT,type="return.level",return.period = 100)
ci.mle.1000 <- ci(FitthreshMle,type="return.level",return.period = 1000)
ci.exp.1000 <- ci(FitthreshMleExp,type="return.level",return.period = 1000)
ci.mmt.1000 <- ci(FitthreshMleMMT,type="return.level",return.period = 1000)

```

Méthode         |  100-year return  |  IC 95% borne Inf  | IC 95% borne Sup   |
--------------- | ----------------- | ------------------ | ------------------ |
MLE GPD         | `r ci.mle.100[2]` | `r ci.mle.100[1]`  | `r ci.mle.100[3]`  |
MLE Exponentiel | `r ci.exp.100[2]` | `r ci.exp.100[1]`  | `r ci.exp.100[3]`  |
Moment GPD     | `r ci.mmt.100[2]` | `r ci.mmt.100[1]`  | `r ci.mmt.100[3]`  |


Méthode         |  1000-year return |  IC 95% borne Inf  | IC 95% borne Sup   |
--------------- | ----------------- | ------------------ | ------------------ |
MLE GPD         | `r ci.mle.1000[2]`| `r ci.mle.1000[1]` | `r ci.mle.1000[3]` |
MLE Exponentiel | `r ci.exp.1000[2]`| `r ci.exp.1000[1]` | `r ci.exp.1000[3]` |
Moment GPD     | `r ci.mmt.1000[2]`| `r ci.mmt.1000[1]` | `r ci.mmt.1000[3]` |

```{r echo=FALSE}
ret.mle<- return.level(FitthreshMle, return.period = c(2, 20, 100,1000))
ret.exp<- return.level(FitthreshMleExp, return.period = c(2, 20, 100,1000))
ret.mmt<- return.level(FitthreshMleMMT, return.period = c(2, 20, 100,1000))
```

Méthode         |  2-year level  |  20-year level | 100-year level | 1000-year level|
--------------- | -------------- | -------------- | -------------- | -------------- |
MLE GPD         | `r ret.mle[1]` | `r ret.mle[2]` | `r ret.mle[3]` | `r ret.mle[4]` |
MLE Exponentiel | `r ret.exp[1]` | `r ret.exp[2]` | `r ret.exp[3]` | `r ret.exp[4]` |
Moment GPD      | `r ret.mmt[1]` | `r ret.mmt[3]` | `r ret.mmt[3]` | `r ret.mmt[4]` |

```{r echo=FALSE}

```

```{r echo=FALSE}


```


```{r echo=FALSE}

```

```{r echo=FALSE}

```

## Conclusion - Comparaison GEV et GPD

\pagebreak

# Partie II - Approche *GEV* (Genaral Extreme Distribution) - Données *portpirie*

## Lecture des données - description statistique

```{r echo=FALSE}
data.portpirie<-portpirie
```



```{r echo=FALSE, fig.height=4, fig.width=15}
par(mfrow=c(1,2))
portpirie.ts = ts(data.portpirie,start=c(1923) , end=(1987),frequency=1) #
plot(portpirie.ts,main="Sea level in portpirie - Australia",ylab="sea level (m)")
#matPluies = matrix(pluies,365,127) # decoupage en annees aout-juillet
#maxPluies = apply(matPluies,2,max,na.rm = TRUE)
#vecAn = 1864:1990
#plot(portpirie,main="Sea level in portpirie - Australia")
emplot(portpirie,main="Fonction de survie empirique - max niveau de la mer")

```

```{r echo=FALSE}
summary(data.portpirie)
```

```{r echo=FALSE}
quantile(data.portpirie,probs=c(0,0.25,0.5,0.75,1))
```


```{r echo=FALSE, fig.height=5, fig.width=15}
par(mfrow=c(1,2))
h <- hist(data.portpirie,main="Maximum annuel du niveau de la mer à portperie", xlab="Niveau de  la mer",col="lightblue",ylim=c(0,15),breaks=10)
text(h$mids,h$counts,labels=h$counts, adj=c(0.5, -0.5))
plot(portpirie,main="Sea level in portperie - Australia",ylab="sea level (m)",pch=16)

```

* Comparaison à une loi Log-normale et Gamma

```{r echo=FALSE, message=FALSE, warning=FALSE}
fitLognorm<-fitdist(data.portpirie,"lnorm")
fitGamma<-fitdist(data.portpirie,"gamma")
```

```{r echo=FALSE}
sLnorm<-summary(fitLognorm)
sGamma<-summary(fitGamma)

```

```{r echo=FALSE}
sLnorm
```

```{r echo=FALSE}
sGamma
```


```{r echo=FALSE, fig.height=5, fig.width=15, message=FALSE, warning=FALSE}
par(mfrow=c(1,2))

denscomp(fitLognorm,legendtext = "Lognormal",lwd=2)
denscomp(fitGamma,legendtext = "Gamma",lwd=2)
```

```{r echo=FALSE}
qlnorm(1/400,meanlog=sLnorm$estimate[1],sdlog=sLnorm$estimate[2],lower.tail = FALSE)
qlnorm((1-1/400),meanlog=sLnorm$estimate[1],sdlog=sLnorm$estimate[2],lower.tail = TRUE)
qgamma(1/400, sGamma$estimate[1], sGamma$estimate[2], lower.tail = FALSE)
qgamma((1-1/400), sGamma$estimate[1], sGamma$estimate[2], lower.tail = TRUE)
qlnorm(1/4000,meanlog=sLnorm$estimate[1],sdlog=sLnorm$estimate[2],lower.tail = TRUE)
qgamma(1/4000, sGamma$estimate[1], sGamma$estimate[2], lower.tail = FALSE)
summary(data.portpirie)
```


```{r echo=FALSE}

```

## Choix des blocs

```{r echo=FALSE}

```


```{r echo=FALSE}

```

## Estimation des paramètres par MLE et PWM.

```{r echo=FALSE, message=FALSE, warning=FALSE}
FitMle.portpirie=fevd(portpirie,type="GEV",method="MLE",time.units="days")#,time.units="day")
gev<-FitMle.portpirie
ci.gev<-ci(FitMle.portpirie,type="parameter")

gev.scale<- gev$results[1]$par[1]
gev.shape<- gev$results[1]$par[2]

FitGumb.portpirie=fevd(portpirie,type="Gumbel",method="MLE",time.units="days")#,time.units="day")
gumb<-FitGumb.portpirie
ci.gumb<-ci(FitGumb.portpirie,type="parameter")

#FitMMT=fevd(portpirie,type="GP",method="Lmoments",time.units="days")
#gev.mmt<-FitMMT
#ci.gev.mmt<-ci(FitMMT,type="parameter")

#GEV - Moments   | `r gev.mmt$results[1]`     | `r gev.mmt$results[2]`     |
```

Méthode          |        scale               |            shape           |
---------------- | -------------------------- | -------------------------- |
GEV - MLE GV     | `r gev$results[1]$par[1]`  | `r gev$results[1]$par[2]`  |
GEV - MLE Gumbel | `r gumb$results[1]$par[1]` | `r gumb$results[1]$par[2]` |

* Graphique - Approximation GEV par MLE

```{r echo=FALSE, fig.height=7, fig.width=15}
plot(FitMle.portpirie)
```

Les graphiques qqplot et qqplot2 montrent une très bonne adéquation des valeurs observées aux valeurs théoriques estimées.
Bien qu'ici le gplot2 soit un peu moins bon. La forme de la densité théorique et estimé sont aussi très proches. 
On en conclu que l'approximation est de bonne qualité.

* Graphique - Approximation Gumble par MLE

```{r echo=FALSE, fig.height=8, fig.width=15}
plot(FitGumb.portpirie)
```
Là aussi les graphiques qqplot et qqplot2 montrent une très bonne adéquation des valeurs observées aux valeurs théoriques estimées.
Il en est de même pour la forme de la densité. On en conclu que l'approximation est de bonne qualité.

## Domaine d'attraction

On étudie le signe de $\gamma$ pour connaître le type de domaine d'attraction: Weibull, Gumbel ou Fréchet.

* Approximations des paramètres $scale$ et $shape$ et Intervalles de confiance

```{r echo=FALSE}
ci.gev
ci.gumb
#ci.gev.mmt
```

Ici le domaine d'attraction le plus probable semble être de type Gumbel: $\gamma=0$

```{r echo=FALSE}
#plot(FitGumb.portpirie,type ="qq",main="qq Gumbel")
#plot(FitGumb.portpirie,type ="qq2",main="qq2 Gumbel")
#plot(FitGumb.portpirie,type ="density",main="Density Gumbel")
```

## Niveau de retour et interprétation

```{r echo=FALSE, fig.height=4, fig.width=12}
par(mfrow=c(1,2))

plot(FitMle.portpirie,type ="rl",main="Return period - GEV" )
plot(FitGumb.portpirie,type ="rl",main="Return period - Gumbel" )
```

```{r echo=FALSE}
ret.gev<- return.level(FitMle.portpirie, return.period = c(2, 20, 100,1000))
ret.gmb<- return.level(FitGumb.portpirie, return.period = c(2, 20, 100,1000))
#ret.mmt<- return.level(FitthreshMleMMT, return.period = c(2, 20, 100,1000))
```

Méthode         |  2-year level  |  20-year level | 100-year level | 1000-year level|
--------------- | -------------- | -------------- | -------------- | -------------- |
MLE GV          | `r ret.gev[1]` | `r ret.gev[2]` | `r ret.gev[3]` | `r ret.gev[4]` |
MLE Gumbel      | `r ret.gmb[1]` | `r ret.gmb[2]` | `r ret.gmb[3]` | `r ret.gmb[4]` |


```{r echo=FALSE}

```

## Estimation du niveau de retour correspondant à une période 100 ans et 1000 ans

```{r echo=FALSE}
ci.gev.100 <- ci(FitMle.portpirie,type="return.level",return.period = 100)
ci.gmb.100 <- ci(FitGumb.portpirie,type="return.level",return.period = 100)
#ci.mmt.100 <- ci(FitMMT,type="return.level",return.period = 100)
ci.gev.1000 <- ci(FitMle.portpirie,type="return.level",return.period = 1000)
ci.gmb.1000 <- ci(FitGumb.portpirie,type="return.level",return.period = 1000)
#ci.mmt.1000 <- ci(FitMMT,type="return.level",return.period = 1000)

#Moment GV      | `r ci.mmt.100[2]` | `r ci.mmt.100[1]`  | `r ci.mmt.100[3]`  |
#Moment GV      | `r ci.mmt.1000[2]`| `r ci.mmt.1000[1]` | `r ci.mmt.1000[3]` |
```

Méthode         |  100-year return  |  IC 95% borne Inf  | IC 95% borne Sup   |
--------------- | ----------------- | ------------------ | ------------------ |
MLE GV          | `r ci.gev.100[2]` | `r ci.gev.100[1]`  | `r ci.gev.100[3]`  |
MLE Gumbel      | `r ci.gmb.100[2]` | `r ci.gmb.100[1]`  | `r ci.gmb.100[3]`  |



Méthode         |  1000-year return |  IC 95% borne Inf  | IC 95% borne Sup   |
--------------- | ----------------- | ------------------ | ------------------ |
MLE GV          | `r ci.gev.1000[2]`| `r ci.gev.1000[1]` | `r ci.gev.1000[3]` |
MLE Gumbel      | `r ci.gmb.1000[2]`| `r ci.gmb.1000[1]` | `r ci.gmb.1000[3]` |




```{r echo=FALSE}

```


```{r echo=FALSE}
#Estimation des paramètres avec *fgev*
library(evd)
fgev.portpirie <- fgev(portpirie)
fgev.portpirie
```

```{r echo=FALSE, fig.height=5, fig.width=15, message=FALSE, warning=FALSE}
par(mfrow=c(1,2))
#Quantiles extrêmes
port.qfit=fgev(portpirie,prob=0.01)
port.qdev_prof=profile(port.qfit,which="quantile")
port.qPCI=plot(port.qdev_prof,main="Profile deviance of Quantile 0.01")
port.qfit=fgev(portpirie,prob=0.001)
port.qdev_prof=profile(port.qfit,which="quantile")
port.qPCI=plot(port.qdev_prof,main="Profile deviance of Quantile 0.001")
```

## Conclusion

\pagebreak

# Partie III  - Approche *GPD* (Globale Pareto Distribution) - Données *temps100m*

## Lecture des données - description statistique

Ici on s'intéresse à la loi des miniùuns. Aussi pour étudier la loi des maximum ici on va inverser et regarder les temps en prenant l'opposé.  
```{r echo=FALSE, message=FALSE, warning=FALSE}
#require(stats)
temps100m = read.csv("./temps100m.csv",col.names = T)
time=temps100m[,1]
vtime<-as.vector(t(time))
class(vtime)
Time=sort(vtime,decreasing=TRUE) # pour ordonner les données.
#plot(Time, ylab="Temps (secondes)", main="Records au 100M",type="l")
# As a last step all smoothed times are converted into speeds.
# Higher speeds correspond to "better" times.
TimeNeg<--Time
```

```{r echo=FALSE}
summary(TimeNeg)
```

```{r echo=FALSE}
quantile(TimeNeg,probs=c(0,0.25,0.5,0.75,1))
```

```{r echo=FALSE, fig.height=5, fig.width=15}
par(mfrow=c(1,2))
h <- hist(TimeNeg,main="Maximum des temps au 100m", xlab="Temps au 100m",col="lightblue",ylim=c(0,500),breaks=10)
text(h$mids,h$counts,labels=h$counts, adj=c(0.5, -0.5))
plot(TimeNeg,main="Maximum des temps au 100m",ylab="Temps au 100m",pch=16)

```

```{r echo=FALSE}

```

## Choix du niveau de seuillage

* function findthresh of the package evir (p38 cours III)

```{r echo=FALSE}
findthresh(TimeNeg,c(1,10,100))
```

```{r echo=FALSE}
seuil<-findThreshold(as.timeSeries(TimeNeg), n = c(10, 50, 100))
seuil
```

```{r echo=FALSE, fig.height=4, fig.width=12}
par(mfrow=c(1,2))
plot(TimeNeg,main="Temps au 100m")
abline(h=seuil[1],col="red")
abline(h=seuil[2],col="red",lty=2)
abline(h=seuil[3],col="red",lty=3)
legend('top',c("seuil à 10","seuil à 50","seuil à 100"),col="red",lty=c(1,2,3),lwd = rep(2,2))

mrlplot(TimeNeg,main="Mean Residual Life Plot - Temps au 100m")
```

* A partir des graphes tcplot: partie constante du graphe.

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE}
threshrange.plot(TimeNeg)
```

On obtient un seuil paproximatif de -9.92

```{r echo=FALSE}

```


## Estimation des paramètres par MLE et PWM.

On utilise la fonction R fved avec 2 la méthode MLE et des moments

```{r echo=FALSE}
seuil<--9.92

FitthreshMle.100m=fevd(TimeNeg,threshold=seuil,type="GP",method="MLE",time.units="days")#,time.units="day")
mle<-FitthreshMle.100m
ci.mle<-ci(FitthreshMle.100m,type="parameter")

FitthreshMleExp.100m=fevd(TimeNeg,threshold=seuil,type="Exponential",method="MLE",time.units="days")
exp<-FitthreshMleExp.100m
ci.exp<-ci(FitthreshMleExp.100m,type="parameter")

FitthreshMleMMT.100m=fevd(TimeNeg,threshold=seuil,type="GP",method="Lmoments",time.units="days")
mmt<-FitthreshMleMMT.100m
ci.mmt<-ci(FitthreshMleMMT.100m,type="parameter")

```

Méthode         |        scale              |            shape          |
--------------- | ------------------------- | ------------------------- |
MLE GPD         | `r mle$results[1]$par[1]` | `r mle$results[1]$par[2]` |
MLE Exponentiel | `r exp$results[1]$par[1]` | `r exp$results[1]$par[2]` |
Moment GPD      | `r mmt$results[1]`        | `r mmt$results[2]`        |

\pagebreak

* Graphique - GPD estimé par MLE 

```{r echo=FALSE, fig.height=8, fig.width=15}
plot(FitthreshMle.100m)
```

* Graphique - Exponentiel estimé par MLE 

```{r echo=FALSE, fig.height=8, fig.width=12}
plot(FitthreshMleExp.100m)
```

\pagebreak

* Graphique - GPD estimé par les moments 

```{r echo=FALSE, fig.height=8, fig.width=12}
plot(FitthreshMleMMT.100m)
```

## Domaine d'attraction


```{r echo=FALSE}

```

* Approximations des paramètres $scale$ et $shape$ et Intervalles de confiance

```{r echo=FALSE}
ci.mle
ci.exp
ci.mmt
```


```{r echo=FALSE}

```

## Niveau de retour et interprétation

```{r echo=FALSE, fig.height=4, fig.width=15}
par(mfrow=c(1,3))

plot(FitthreshMle.100m,type ="rl",main="Return period - Global Pareto estimée par MLE" )
plot(FitthreshMleExp.100m,type ="rl",main="Return period - Exp estimée par MLE" )
plot(FitthreshMleMMT.100m,type ="rl",main="Return period - Global Pareto estimée par les moments" )
```

```{r echo=FALSE}
ret.mle<- return.level(FitthreshMle.100m, return.period = c(20, 50, 100,1000))
ret.exp<- return.level(FitthreshMleExp.100m, return.period = c(20, 50, 100,1000))
ret.mmt<- return.level(FitthreshMleMMT.100m, return.period = c(20, 50, 100,1000))
```

Méthode         |  20-year level |  50-year level | 100-year level | 1000-year level|
--------------- | -------------- | -------------- | -------------- | -------------- |
MLE GPD         | `r ret.mmt[1]` | `r ret.mmt[2]` | `r ret.mmt[3]` | `r ret.mmt[4]` |
MLE Exponentiel | `r ret.exp[1]` | `r ret.exp[2]` | `r ret.exp[3]` | `r ret.exp[4]` |
Moment GPD      | `r ret.mmt[1]` | `r ret.mmt[3]` | `r ret.mmt[3]` | `r ret.mmt[4]` |



```{r echo=FALSE}

```

## Estimation du niveau de retour correspondant à une période 100 ans et 1000 ans

```{r echo=FALSE}
ci.mle.100 <- ci(FitthreshMle.100m,type="return.level",return.period = 100)
ci.exp.100 <- ci(FitthreshMleExp.100m,type="return.level",return.period = 100)
ci.mmt.100 <- ci(FitthreshMleMMT.100m,type="return.level",return.period = 100)
ci.mle.1000 <- ci(FitthreshMle.100m,type="return.level",return.period = 1000)
ci.exp.1000 <- ci(FitthreshMleExp.100m,type="return.level",return.period = 1000)
ci.mmt.1000 <- ci(FitthreshMleMMT.100m,type="return.level",return.period = 1000)

```

Méthode         |  100-year return  |  IC 95% borne Inf  | IC 95% borne Sup   |
--------------- | ----------------- | ------------------ | ------------------ |
MLE GPD         | `r ci.mle.100[2]` | `r ci.mle.100[1]`  | `r ci.mle.100[3]`  |
MLE Exponentiel | `r ci.exp.100[2]` | `r ci.exp.100[1]`  | `r ci.exp.100[3]`  |
Moment GPD      | `r ci.mmt.100[2]` | `r ci.mmt.100[1]`  | `r ci.mmt.100[3]`  |


Méthode         |  1000-year return |  IC 95% borne Inf  | IC 95% borne Sup   |
--------------- | ----------------- | ------------------ | ------------------ |
MLE GPD         | `r ci.mle.1000[2]`| `r ci.mle.1000[1]` | `r ci.mle.1000[3]` |
MLE Exponentiel | `r ci.exp.1000[2]`| `r ci.exp.1000[1]` | `r ci.exp.1000[3]` |
Moment GPD      | `r ci.mmt.1000[2]`| `r ci.mmt.1000[1]` | `r ci.mmt.1000[3]` |




```{r echo=FALSE}

```


```{r echo=FALSE}

```


## Conclusion








